<!doctype html>
<html>
<head>
    <title>StationStatus</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,600,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="ui.core.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.closest.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.stations.css" />
    <link rel="stylesheet" type="text/css" href="ui.allstations.css" />
    


    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="oop.js"></script>
    <script type="text/javascript" src="geo.js"></script>
    <script type="text/javascript" src="ui.js"></script>
    <script type="text/javascript">
    $(function() {
        metro = new Rail({
            DisplayName: "Washington Metro"
        });
        var _st = +new Date;
        WMATA.getblob(function() {
            metro.fill();
            console.info("Load time: "+(+new Date - _st)+"ms");
            stationsInit();
        });

        assign(".logo", "ui-home.html");

        stationsInit = function() {
            var st = +new Date;
            var stns = [];
            for(code in metro.stations) {
                stns.push(metro.stations[code]);
            }
            // Sort alphabetically
            stns.sort(function(a, b) {
                return a.name > b.name ? 1 : -1;
            });
            for(var i=0; i<stns.length; i++) {
                addStation(stns[i]);
            }
            $(".loading").hide();
            console.debug("Sorted in "+(+new Date - st)+"ms");
            checkQuery();
        }
        addStation = function(st) {
            var str = '<li class="card' + (st.transfer ? ' transfer' : '') + '" data-name="' + st.name + '" data-station="' + st.code + '" data-lines="" onclick="return clickStation.bind(this)()">\n' +
                      st.name + '\n' +
                      '<div class="lines">\n';
            for(var i=0; i<st.totalLines.length; i++) {
                var ln = st.totalLines[i];
                str +='<span class="' + ln.code.toLowerCase() + '">' + ln.code + '</span>\n';
                str = str.replace('data-lines="', 'data-lines=",' + ln.code);
            }
            str +=    '</div>\n</li>';
            // Remove leading , in lines list
            str = str.replace('data-lines=",', 'data-lines="');
            // Only show Metro Center and L'Enfant once
            if($(".contents ul.allstations .card[data-name='" + st.name + "']").length > 0) {
                console.debug("Skipping second "+st.name);
                return;
            }
            $(".contents ul.allstations").append(str);
        }
        clickStation = function() {
            var st = $(this).attr("data-station");
            console.info("CLICK: "+st);
            setTimeout(function() {
                location.href = "ui-station.html#id=" + st;
            }, 400);

        }
        searchInit = function() {
            $(".search > input").on("input", searchCheck);
            $(".search .search-icon").click(function() {
                $(this).parent().addClass("open");
                setTimeout(function() {
                    $(".search > input").focus();
                }, 400);
            }).hover(function() {
                setTimeout(function() {
                    $(".search > input").focus();
                }, 400);
            }, function() {
                $(".search .search-icon").focus();
            });
            $(".header .title").css("cursor", "pointer").click(function() {
                if($(".search").hasClass("open")) {
                    $(".search").removeClass("open");
                }
            })
        }
        searchCheck = function() {
            searchQuery($(this).val());
            if($(this).val().trim().length <= 1) {
                $(this).parent().removeClass("open");
            } else {
                $(this).parent().addClass("open");
            }
        }
        searchQuery = function(q, dir) {
            var st = +new Date;
            console.debug("Search: "+q);
            $c = $(".contents ul.allstations .card");
            var trues = [];
            q = q.trim();
            $(".header .title").css("color", "").html("All Stations");
            $(".header").css("background-color", "");
            $(".card.seestdetail").hide();

            if(q.length == 0) {
                $c.show();
                return;
            }
            
            for(linecode in metro.lines) {
                var line = metro.lines[linecode];
                var parts = q.toLowerCase().split(" ");
                for(var i=0; i<parts.length; i++) {
                    if(parts[i] == line.name.toLowerCase() || parts[i] == linecode.toLowerCase()) {
                        console.info("Showing "+line.name+" Line");
                        $(".header .title").html(line.name+" Line");
                        $(".header").css("background-color", "#"+metro.colors[linecode]);
                        if(~$.inArray(line.code, metro.colorsBlack)) {
                            $(".header .title").css("color", "black");
                        }
                        $(".card.seestdetail span").html(line.name);
                        $(".card.seestdetail").css("color", "#"+metro.colors[linecode]).show();
                        break;
                    }
                }
            }
            $c.each(function() {
                if(searchTest.bind(this)(q)) {
                    $(this).show();
                    try {
                        trues.push(metro.stations[$(this).attr("data-station")]);
                    } catch(e) {}
                } else {
                    $(this).hide();
                }
            });
            if(trues.length == 0) {
                $(".contents ul.allstations .none").show();
            } else {
                $(".contents ul.allstations .none").hide();
            }
            location.hash = "#q=" + q;
            console.info("Query took "+(+new Date - st)+"ms", trues);
        }
        searchTest = function(q) {
            var stcode = $(this).attr("data-station");
            var st = metro.stations[stcode];
            q = q.toLowerCase();
            if(st) {
                var success = [];
                var parts = q.split(" ");
                loop1:
                for(var i=0; i<parts.length; i++) {
                    parts[i] = parts[i].toLowerCase().trim();
                    if(st.name.toLowerCase().indexOf(parts[i]) != -1 || st.code.toLowerCase() == parts[i]) {
                        success[i] = true;
                        continue;
                    }
                    loop2:
                    for(var j=0; j<st.totalLines.length; j++) {
                        var ln = st.totalLines[j];
                        if(parts[i] == ln.name.toLowerCase() || parts[i] == ln.code.toLowerCase()) {
                            success[i] = true;
                            continue loop1;
                        }
                    }
                    success[i] = false;
                }
                console.log(parts, success);
                for(var i=0; i<success.length; i++) {
                    if(!success[i] || success.length != parts.length) return false;
                }
                return true;
            }
            return false;
        }
        checkQuery = function() {
            if(location.hash.indexOf('q=') != -1) {
                var q = location.hash.split('q=')[1];
                console.info("Searching from querystring: "+q);
                searchQuery(q, true);
                $(".search").addClass("open");
                $(".search > input").val(q);
            }
        }
        searchInit();
    });
    </script>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo back">
            M
        </div>
        <div class="title">All Stations</div>
        <div class="search">
            <div class="search-icon"></div>
            <input type="search" placeholder="Search" />
        </div>
    </div>

    <div class="contents">
        <div class="card seestdetail">
            <div class="bottom-button">
                View <span></span> Line Details
            </div>
        </div>
        <ul class="metrograph allstations">
            <div class="loading"></div>
            <!-- <li class="card">
                Vienna
                <div class="lines">
                    <span class="or">OR</span>
                </div>
            </li>
            <li class="card transfer">
                Rosslyn
                <div class="lines">
                    <span class="or">OR</span>
                    <span class="sv">SV</span>
                    <span class="bl">BL</span>
                </div>
            </li> -->
            <div class="none">
                No stations were found.
            </div>
        </ul>


    </div>
</div>
</body>
</html>