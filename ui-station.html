<!doctype html>
<html>
<head>
    <title>StationStatus</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,600,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="ui.core.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.lines.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.closest.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.stations.css" />
    <link rel="stylesheet" type="text/css" href="ui.station.css" />
    


    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="oop.js"></script>
    <script type="text/javascript" src="geo.js"></script>
    <script type="text/javascript" src="ui.js"></script>
    <script type="text/javascript">
    $(function() {
        metro = new Rail({
            DisplayName: "Washington Metro"
        });
        var _st = +new Date;
        WMATA.getblob(function() {
            metro.fill();
            console.info("Load time: "+(+new Date - _st)+"ms");
            station.init();
        });
        assign(".logo", "ui-stations.html");

        station = {
            id: null,
            st: null,
            init: function() {
                if(location.hash.indexOf('station=') != -1) {
                    this.id = location.hash.split('station=')[1];
                    this.id = this.id.split('&')[0];
                    this.st = metro.stations[this.id];
                    if(typeof this.st == 'undefined') return;
                    this.add();
                }
                $(window).on("hashchange", function() {
                    location.reload();
                });
            },
            add: function() {
                this.showInformation();
                this.getPrediction();

                $(".loading").hide();
            },
            showInformation: function() {
                $(".header .title").html(this.st.name+" Station");
                this.showColorbar();
                var url = geo.getMapsURL(this.st.coords.lat, this.st.coords.long, 15);
                $(".contents .stationinfo").attr("style", "background-image: url('" + url + "')");
                this.showOrder();
            },
            showOrder: function() {
                $tpl = $(".contents .card-template.order");
                for(line in this.st.next) {
                    $l = $tpl.clone();
                    var nxt = this.st.next[line], en;
                    if(nxt) {
                        $(".half-bottom-button .right", $l).attr("data-station", nxt.code).html(nxt.name);
                        $(".half-bottom-button .right", $l).addClass(line.toLowerCase());
                        en = metro.stations[metro.lines[line].codes.end];
                        $(".toward .right", $l).html(en.name);
                    } else {
                        $(".right", $l).css("visibility", "hidden");
                    }
                    var prv = this.st.prev[line], st;
                    if(prv) {
                        $(".half-bottom-button .left", $l).attr("data-station", prv.code).html(prv.name);
                        $(".half-bottom-button .left", $l).addClass(line.toLowerCase());
                        st = metro.stations[metro.lines[line].codes.start];
                        $(".toward .left", $l).html(st.name);
                    } else {
                        $(".left", $l).css("visibility", "hidden");
                    }

                    console.debug(line+" prev: "+prv+" next: "+nxt);
                    console.debug(line+" starts: "+st+" ends: "+en);
                    $l.removeClass("card-template").css("display","");
                    $l.addClass("card");
                    $tpl.after($l);
                }

                $(".half-bottom-button > div").click(function() {
                    setTimeout(function() {
                        location.href = "ui-station.html#station=" + $(this).attr("data-station");
                    }.bind(this), 400);
                });
            },
            showColorbar: function() {
                for(var i=0; i<this.st.totalLines.length; i++) {
                    $(".container .multibackground").append("<span style='background-color: #"+metro.colors[this.st.totalLines[i].code]+"; opacity: 1; width: "+(100 / this.st.totalLines.length)+"%'></span>");
                }
            },
            getPrediction: function() {
                WMATA.gettiming(function() {
                    var json = WMATA.timing["Trains"];
                    console.log(json);
                    var tot = 0;
                    for(num in json) {
                        if(json[num].LocationCode == station.st.code) {
                            console.log(json[num]);
                            station.addPrediction(json[num]);
                            num++;
                        }
                    }
                    console.debug("Of "+num+" trains, "+tot+" are at "+station.st);
                    if(tot <= 1) {
                        $(".card.nexttrains table tbody").append("<tr><td colspan=5><center style='font-size: 14px'>There are no trains scheduled to arrive at this station.</center></td></tr>");
                    }
                });
            },
            addPrediction: function(train) {
                $c = $(".card.nexttrains table tbody");
                var mins = min = train.Min;
                if(mins == "ARR") mins = "<span class='arr'>Arriving</span>";
                else if(mins == "BRD") mins = "<span class='brd'>Boarding</span>";
                
                var tm = parseInt(+new Date);
                if(min != "ARR" && min != "BRD") {
                    tm += 60 * parseInt(min) * 1000;
                }
                var time = new Date(tm);
                var timel = time.getHours()+":"+(time.getMinutes()+1);
                var str = '<tr>\n' +
                          '<td class="line"><span class="line ' + train.Line.toLowerCase() + '">' + train.Line + '</span></td>\n' +
                          '<td class="num">' + train.Car + '</td>\n' +
                          '<td class="stop">' + train.DestinationName + '</td>' +
                          '<td class="mins">' + mins + '</td>\n' +
                          '<td class="time">' + timel + '</td>\n' +
                          '</tr>';
                $c.append(str);
            },
            click: function() { // binded: this=object
                var st = $(this).attr("data-station");
                console.info("CLICK: "+st);
                setTimeout(function() {
                    location.href = "ui-station.html#id=" + st;
                }, 400);
            }
        };
    });
    </script>
</head>
<body>

<div class="container">

    <div class="multibackground">
    </div>
    <div class="header">
        <div class="logo back">
            M
        </div>
        <div class="title">Station</div>
    </div>

    <div class="contents">

        <div class="loading"></div>
        <div class="card stationinfo">
            <div class="bottom-button">
                Navigate
            </div>
        </div>

        <div class="card nexttrains">
            <div class="title">
                Next Trains:
            </div>
            <table>
            <thead>
                <tr>
                    <th>Line</th>
                    <th>Cars</th>
                    <th>Destination</th>
                    <th>Mins</th>
                    <th>Arriving At</th>
                </tr>
            </thead>
            <tbody>
            <!--
                <tr>
                    <td class="line"><span class="line or">OR</span></td>
                    <td class="num">6</td>
                    <td class="stop">Glenmont</td>
                    <td class="time">ARR</td>
                </tr>
                <tr>
                    <td class="line"><span class="line or">OR</span></td>
                    <td class="num">6</td>
                    <td class="stop">Glenmont</td>
                    <td class="time">2 min</td>
                </tr>
            -->
            </tbody>
            </table>
        </div>

        <div class="card-template order">
            <div class="toward">
                <span class="left">
                    <!--&laquo;-->
                </span>
                <span class="right">
                    <!-- &raquo;-->
                </span>
            </div>
            <div class="half-bottom-button">
                <div class="bottom-button left">
                    
                </div>
                <div class="bottom-button right">
                    
                </div>
            </div>
        </div>

        <ul class="metrograph allstations">
            <!-- <li class="card">
                Vienna
                <div class="lines">
                    <span class="or">OR</span>
                </div>
            </li>
            <li class="card transfer">
                Rosslyn
                <div class="lines">
                    <span class="or">OR</span>
                    <span class="sv">SV</span>
                    <span class="bl">BL</span>
                </div>
            </li> -->
        </ul>


    </div>
</div>
</body>
</html>