<!doctype html>
<html>
<head>
    <title>StationStatus</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,600,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="ui.core.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.closest.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.stations.css" />
    <link rel="stylesheet" type="text/css" href="ui.allstations.css" />
    


    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="oop.js"></script>
    <script type="text/javascript" src="geo.js"></script>
    <script type="text/javascript" src="ui.js"></script>
    <script type="text/javascript">
    $(function() {
        metro = new Rail({
            DisplayName: "Washington Metro"
        });
        var _st = +new Date;
        WMATA.getblob(function() {
            metro.fill();
            console.info("Load time: "+(+new Date - _st)+"ms");
            stationsInit();
        });

        assign(".logo", "ui-home.html");

        stationsInit = function() {
            if(location.hash.indexOf('line=') != -1) {
                var id = location.hash.split('line=')[1];
                id = id.split('&')[0];
                stationsInitLine(id.toUpperCase());
            } else {
                console.error("No line given");
                $(".contents > ul.allstations").html("<center>No line given</center>");
                return
            }
        }
        stationsInitLine = function(lin) {
            var st = +new Date;
            var stns = [];
            if(typeof metro.lines[lin] == 'undefined') {
                console.error("Invalid line: "+lin);
                $(".contents > ul.allstations").html("<center>Invalid line: "+lin+"</center>");
                return;
            }

            var line = metro.lines[lin];
            for(var i=0; i<line.route.length; i++) {
                addStation(line.route[i]);
            }
            $(".loading").hide();
            console.debug("Sorted in "+(+new Date - st)+"ms");

            console.info("Showing "+line.name+" Line");
            $(".header .title").html(line.name+" Line");
            $(".header").css("background-color", "#"+metro.colors[line.code]);
            if(~$.inArray(line.code, metro.colorsBlack)) {
                $(".header .title").css("color", "black");
            }
            checkQuery();
        }
        addStation = function(st) {
            var str = '<li class="card' + (st.transfer ? ' transfer' : '') + '" data-station="' + st.code + '" data-lines="" onclick="return clickStation.bind(this)()">\n' +
                      st.name + '\n' +
                      '<div class="lines">\n';
            for(var i=0; i<st.totalLines.length; i++) {
                var ln = st.totalLines[i];
                str +='<span class="' + ln.code.toLowerCase() + '">' + ln.code + '</span>\n';
                str = str.replace('data-lines="', 'data-lines=",' + ln.code);
            }
            str +=    '</div>\n</li>';
            // Remove leading , in lines list
            str = str.replace('data-lines=",', 'data-lines="');
            $(".contents ul.allstations").append(str);
        }
        clickStation = function() {
            var st = $(this).attr("data-station");
            console.info("CLICK: "+st);
            setTimeout(function() {
                location.href = "ui-station.html#id=" + st;
            }, 400);

        }
        searchInit = function() {
            $(".search > input").keyup(searchCheck);
            $(".search .search-icon").click(function() {
                $(this).parent().addClass("open");
                setTimeout(function() {
                    $(".search > input").focus();
                }, 400);
            }).hover(function() {
                setTimeout(function() {
                    $(".search > input").focus();
                }, 400);
            }, function() {
                $(".search .search-icon").focus();
            });
            $(".header .title").css("cursor", "pointer").click(function() {
                if($(".search").hasClass("open")) {
                    $(".search").removeClass("open");
                }
            })
        }
        searchCheck = function() {
            searchQuery($(this).val());
            if($(this).val().trim().length <= 1) {
                $(this).parent().removeClass("open");
            } else {
                $(this).parent().addClass("open");
            }
        }
        searchQuery = function(q, dir) {
            var st = +new Date;
            console.debug("Search: "+q);
            $c = $(".contents ul.allstations .card");
            var trues = [];
            q = q.trim();
            if(q.length == 0) {
                $c.show();
                return;
            }

            $c.each(function() {
                if(searchTest.bind(this)(q)) {
                    $(this).show();
                    try {
                        trues.push(metro.stations[$(this).attr("data-station")]);
                    } catch(e) {}
                } else {
                    $(this).hide();
                }
            });
            if(trues.length == 0) {
                $(".contents ul.allstations .none").show();
            } else {
                $(".contents ul.allstations .none").hide();
            }
            location.hash = "#q=" + q;
            console.info("Query took "+(+new Date - st)+"ms", trues);
        }
        searchTest = function(q) {
            var stcode = $(this).attr("data-station");
            var st = metro.stations[stcode];
            q = q.toLowerCase();
            if(st) {
                if(st.name.toLowerCase().indexOf(q) != -1) return true;
                if(st.code.toLowerCase() == q) return true;
                for(var i=0; i<st.totalLines.length; i++) {
                    var ln = st.totalLines[i];
                    if(q == ln.name.toLowerCase() || q == ln.code.toLowerCase()) {
                        return true;
                    }
                }
            }
            return false;
        }
        checkQuery = function() {
            if(location.hash.indexOf('q=') != -1) {
                var q = location.hash.split('q=')[1];
                q = q.split('&')[0];
                console.info("Searching from querystring: "+q);
                searchQuery(q, true);
                $(".search").addClass("open");
                $(".search > input").val(q);
            }
        }
        searchInit();
    });
    </script>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo back">
            M
        </div>
        <div class="title">Line Information</div>
        <div class="search">
            <div class="search-icon"></div>
            <input type="search" placeholder="Search" />
        </div>
    </div>

    <div class="contents">
        <ul class="metrograph allstations">
            <div class="loading"></div>
            <!-- <li class="card">
                Vienna
                <div class="lines">
                    <span class="or">OR</span>
                </div>
            </li>
            <li class="card transfer">
                Rosslyn
                <div class="lines">
                    <span class="or">OR</span>
                    <span class="sv">SV</span>
                    <span class="bl">BL</span>
                </div>
            </li> -->
            <div class="none">
                No stations were found.
            </div>
        </ul>


    </div>
</div>
</body>
</html>